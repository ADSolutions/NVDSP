<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>NVDSP by bartolsthoorn</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>NVDSP</h1>
        <p>iOS/OSX DSP for audio (Novocaine)</p>
        <p class="view"><a href="https://github.com/bartolsthoorn/NVDSP">View the Project on GitHub <small>bartolsthoorn/NVDSP</small></a></p>
        <ul>
          <li><a href="https://github.com/bartolsthoorn/NVDSP/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/bartolsthoorn/NVDSP/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/bartolsthoorn/NVDSP">View On <strong>GitHub</strong></a></li>
        </ul>

				<p>Share it on Twitter:<br><a href="https://twitter.com/share" class="twitter-share-button" data-via="BartOlsthoorn" data-size="large" data-hashtags="NVDSP">Tweet</a>
				<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>
      </header>
      <section>
        <h2>High-performance DSP for audio on iOS and OSX with Novocaine.</h2>

<p>While Novocaine allows you to easily read/play audio, it is still quite hard to apply filters to the audio. This (Objective-C++) class will allow you to apply all sorts of filters (high-pass, band-pass, peaking EQ, shelving EQ etc.) in just a few lines of code.</p>

<h3>Quick introduction/example (highpass filter)</h3>

<div class="highlight">
<pre><span class="cp">// ... import Novocaine and audioFilerReader</span>
<span class="cp">#import "NVDSP/NVDSP.h"</span>
<span class="cp">#import "NVDSP/Filters/NVHighpassFilter.h"</span>

<span class="c1">// init Novocaine audioManager</span>
<span class="n">audioManager</span> <span class="o">=</span> <span class="p">[</span><span class="n">Novocaine</span> <span class="n">audioManager</span><span class="p">];</span>
<span class="kt">float</span> <span class="n">samplingRate</span> <span class="o">=</span> <span class="n">audioManager</span><span class="p">.</span><span class="n">samplingRate</span><span class="p">;</span>

<span class="c1">// init fileReader which we will later fetch audio from</span>
<span class="n">NSURL</span> <span class="o">*</span><span class="n">inputFileURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">URLForResource:</span><span class="s">@"Trentemoller-Miss-You"</span> <span class="nl">withExtension:</span><span class="s">@"mp3"</span><span class="p">];</span>

<span class="n">fileReader</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AudioFileReader</span> <span class="n">alloc</span><span class="p">]</span> 
                  <span class="nl">initWithAudioFileURL:</span><span class="n">inputFileURL</span> 
                  <span class="nl">samplingRate:</span><span class="n">audioManager</span><span class="p">.</span><span class="n">samplingRate</span>
                  <span class="nl">numChannels:</span><span class="n">audioManager</span><span class="p">.</span><span class="n">numOutputChannels</span><span class="p">];</span>

<span class="c1">// setup Highpass filter</span>
<span class="n">NVHighpassFilter</span> <span class="o">*</span><span class="n">HPF</span><span class="p">;</span>
<span class="n">HPF</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVHighpassFilter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithSamplingRate:</span><span class="n">samplingRate</span><span class="p">];</span>

<span class="n">HPF</span><span class="p">.</span><span class="n">cornerFrequency</span> <span class="o">=</span> <span class="mf">2000.0f</span><span class="p">;</span>
<span class="n">HPF</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="mf">0.5f</span><span class="p">;</span>

<span class="c1">// setup audio output block</span>
<span class="p">[</span><span class="n">fileReader</span> <span class="n">play</span><span class="p">];</span>
<span class="p">[</span><span class="n">audioManager</span> <span class="nl">setOutputBlock:</span><span class="o">^</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">outData</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">numFrames</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">numChannels</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">fileReader</span> <span class="nl">retrieveFreshAudio:</span><span class="n">outData</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>

    <span class="p">[</span><span class="n">HPF</span> <span class="nl">filterData:</span><span class="n">outData</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
<span class="p">}];</span>
</pre>
</div>


<h3>More examples</h3>

<h4>Peaking EQ filter</h4>

<div class="highlight">
<pre><span class="n">NVPeakingEQFilter</span> <span class="o">*</span><span class="n">PEF</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVPeakingEQFilter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithSamplingRate:</span><span class="n">audioManager</span><span class="p">.</span><span class="n">samplingRate</span><span class="p">];</span>
<span class="n">PEF</span><span class="p">.</span><span class="n">centerFrequency</span> <span class="o">=</span> <span class="mf">1000.0f</span><span class="p">;</span>
<span class="n">PEF</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="mf">3.0f</span><span class="p">;</span>
<span class="n">PEF</span><span class="p">.</span><span class="n">G</span> <span class="o">=</span> <span class="mf">20.0f</span><span class="p">;</span>
<span class="p">[</span><span class="n">PEF</span> <span class="nl">filterData:</span><span class="n">data</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
</pre>
</div>


<h4>Lowpass filter</h4>

<div class="highlight">
<pre><span class="cp">// import Novocaine.h and NVDSP.h</span>
<span class="cp">#import "NVDSP/Filter/NVLowpassFilter.h"</span>
<span class="n">NVLowpassFilter</span> <span class="o">*</span><span class="n">LPF</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVLowpassFilter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithSamplingRate:</span><span class="n">audioManager</span><span class="p">.</span><span class="n">samplingRate</span><span class="p">];</span>
<span class="n">LPF</span><span class="p">.</span><span class="n">cornerFrequency</span> <span class="o">=</span> <span class="mf">800.0f</span><span class="p">;</span>
<span class="n">LPF</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="mf">0.8f</span><span class="p">;</span>
<span class="p">[</span><span class="n">LPF</span> <span class="nl">filterData:</span><span class="n">data</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
</pre>
</div>


<h4>Notch filter</h4>

<div class="highlight">
<pre><span class="cp">// import Novocaine.h and NVDSP.h</span>
<span class="cp">#import "NVDSP/Filter/NVNotchFilter.h"</span>
<span class="n">NVNotchFilter</span> <span class="o">*</span><span class="n">NF</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVNotchFilter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithSamplingRate:</span><span class="n">audioManager</span><span class="p">.</span><span class="n">samplingRate</span><span class="p">];</span>
<span class="n">NF</span><span class="p">.</span><span class="n">centerFrequency</span> <span class="o">=</span> <span class="mf">3000.0f</span><span class="p">;</span>
<span class="n">NF</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="mf">0.8f</span><span class="p">;</span>
<span class="p">[</span><span class="n">NF</span> <span class="nl">filterData:</span><span class="n">data</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
</pre>
</div>


<h4>Bandpass filter</h4>

<p>There are two types of bandpass filters:</p>

<pre><code>* 0 dB gain bandpass filter (NVBandpassFilter.h)
* Peak gain Q bandpass filter (NVBandpassQPeakGainFilter.h)
</code></pre>

<div class="highlight">
<pre><span class="cp">// import Novocaine.h and NVDSP.h</span>
<span class="cp">#import "NVDSP/Filter/NVBandpassFilter.h"</span>
<span class="n">NVBandpassFilter</span> <span class="o">*</span><span class="n">BPF</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVBandpassFilter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithSamplingRate:</span><span class="n">audioManager</span><span class="p">.</span><span class="n">samplingRate</span><span class="p">];</span>
<span class="n">BPF</span><span class="p">.</span><span class="n">centerFrequency</span> <span class="o">=</span> <span class="mf">2500.0f</span><span class="p">;</span>
<span class="n">BPF</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="mf">0.9f</span><span class="p">;</span>
<span class="p">[</span><span class="n">BPF</span> <span class="nl">filterData:</span><span class="n">data</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
</pre>
</div>


<h4>Measure dB level (ranging from -51.0f to 0.0f)</h4>

<div class="highlight">
<pre><span class="cp">// import Novocaine.h and NVDSP.h</span>
<span class="cp">#import "NVDSP/Utilities/NVSoundLevelMeter.h"</span>
<span class="n">NVSoundLevelMeter</span> <span class="o">*</span><span class="n">SLM</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVSoundLevelMeter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
<span class="kt">float</span> <span class="n">dB</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM</span> <span class="nl">getdBLevel:</span><span class="n">outData</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"dB level: %f"</span><span class="p">,</span> <span class="n">dB</span><span class="p">);</span>
<span class="c1">// NSLogging in an output loop will most likely cause hickups/clicky noises, but it does log the dB level!</span>
<span class="c1">// To get a proper dB value, you have to call the getdBLevel method a few times (it has memory of previous values)</span>
<span class="c1">// You call this inside the input or outputBlock: [audioManager setOutputBlock:^...</span>
</pre>
</div>


<h4>Applying overall gain.</h4>

<p>All sample values (typically -1.0f .. 1.0f when not clipping) are multiplied by the gain value.</p>

<div class="highlight">
<pre><span class="c1">// import Novocaine.h and NVDSP.h</span>
<span class="n">NVDSP</span> <span class="o">*</span><span class="n">generalDSP</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVDSP</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">generalDSP</span> <span class="nl">applyGain:</span><span class="n">outData</span> <span class="nl">length:</span><span class="n">numFrames</span><span class="o">*</span><span class="n">numChannels</span> <span class="nl">gain:</span><span class="mf">0.8</span><span class="p">];</span>
</pre>
</div>


<h3>Clipping</h3>

<p>Multiple peaking EQs with high gains can cause clipping. Clipping is basically sample data that exceeds the maximum or minimum value of 1.0f or -1.0f respectively. Clipping will cause really loud and dirty noises, like a bad overdrive effect. You can use the method <code>counterClipping</code> to prevent clipping (it will reduce the sound level).</p>

<div class="highlight">
<pre><span class="cp">// import Novocaine.h and NVDSP.h</span>
<span class="cp">#import "NVDSP/Utilities/NVClippingDetection.h"</span>
<span class="n">NVClippingDetection</span> <span class="o">*</span><span class="n">CDT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NVClippingDetection</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
<span class="c1">// ... possible clipped outData ...//</span>
<span class="p">[</span><span class="n">CDT</span> <span class="nl">counterClipping:</span><span class="n">outData</span> <span class="nl">threshold:</span><span class="mf">0.8f</span> <span class="nl">numFrames:</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="n">numChannels</span><span class="p">];</span>
<span class="c1">// ... outData is now safe ...//</span>

<span class="c1">// or get the amount of clipped samples:</span>
 <span class="o">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="nl">getClippedSamples:</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="nl">threshold:</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">threshold</span> <span class="nl">numFrames:</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">numChannels</span><span class="p">;</span>
<span class="c1">// or get the percentage of clipped samples:</span>
 <span class="o">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="nl">getClippedPercentage:</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="nl">numFrames:</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">numChannels</span><span class="p">;</span>
<span class="c1">// or get the maximum value of a clipped sample that was found</span>
 <span class="o">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="nl">getClippingSample:</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="nl">threshold:</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">threshold</span> <span class="nl">numFrames:</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">numFrames</span> <span class="nl">numChannels:</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="n">numChannels</span><span class="p">;</span>
</pre>
</div>


<h3>A thing to note:</h3>

<p>The NVDSP class is written in C++, so the classes that use it will have to be Objective-C++. Change all the files that use NVDSP from MyClass.m to MyClass.mm.</p>

<h3>Thanks to</h3>

<p>Alex Wiltschko - Creator of <a href="http://alexbw.github.com/novocaine/">Novocaine</a></p>

<p>Yasoshima - Writer of <a href="http://objective-audio.jp/2008/02/biquad-filter.html">this article</a>, revealing how vDSP_deq22 works. (and google translate, I don't speak Japanese)</p>

<p>hrnt - Helpful on IRC #iphonedev (freenode)</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/bartolsthoorn">bartolsthoorn</a></p>
				<p><a href="https://twitter.com/BartOlsthoorn" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @BartOlsthoorn</a>
				<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-5535798-10");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>